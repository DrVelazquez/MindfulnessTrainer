<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="title">Meditation Trainer</title>
  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Chart.js CDN for progress graph -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Reset & estilos base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #E0F7FA, #B2EBF2);
      color: #333;
      overflow-x: hidden;
    }

    /* -- Banner SOLO en la pantalla 1 -- */
    .home-banner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.95);
      padding: 8px 16px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .progress-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    /* Barra de progreso con texto centrado */
    .progress-container {
      position: relative;
      width: 200px;
      height: 20px;
      background: #B2DFDB;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: #00796B;
      width: 0%;
      transition: width 0.5s ease;
    }
    /* Texto que siempre se muestra centrado encima de la barra */
    .progress-text {
      position: absolute;
      width: 100%;
      text-align: center;
      font-size: 12px;
      line-height: 20px;
      color: #fff;
      pointer-events: none; /* Para que no interfiera en clics */
    }
    .level-info {
      font-size: 12px;
      color: #00796B;
      text-align: center;
    }

    /* Toggle de idioma estilo iOS */
    .lang-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #00796B;
    }
    input:checked + .slider:before {
      transform: translateX(18px);
    }

    /* Estilos generales de cada pantalla */
    .screen {
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      max-width: 600px;
      margin: 20px auto;
      background: rgba(224, 247, 250, 0.9);
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      position: relative;
    }
    .active {
      display: block;
      opacity: 1;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    h1, h2 {
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
    }
    p {
      font-size: 16px;
      line-height: 1.6;
      color: #555;
      margin-bottom: 15px;
    }
    /* Botones */
    .button, .red-button {
      border: none;
      border-radius: 30px;
      margin: 10px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.1s ease;
      font-size: 16px;
      padding: 12px 24px;
    }
    .button {
      background: #fff;
      border: 2px solid #3a3a3a;
      color: #3a3a3a;
    }
    .button:hover {
      background: #3a3a3a;
      color: #fff;
      transform: translateY(-2px);
    }
    .button:active {
      transform: translateY(0);
    }
    .button.selected {
      background: #3a3a3a;
      color: #fff;
    }
    .red-button {
      background: #ff6b6b;
      color: #fff;
      border: none;
    }
    .red-button:hover {
      background: #ff5252;
      transform: translateY(-2px);
    }
    .red-button:active {
      transform: translateY(0);
    }
    /* Bloques de explicaci√≥n */
    .explanation {
      background: rgba(224, 247, 250, 0.8);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      text-align: center;
    }
    /* Card slider para la pantalla inicial */
    .card-slider {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
    }
    .card-content {
      flex: 1;
      padding: 20px;
      text-align: center;
      background: rgba(224, 247, 250, 0.9);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin: 0 10px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .arrow-button {
      background: rgba(179, 229, 252, 0.8);
      border: none;
      color: #fff;
      font-size: 24px;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .arrow-button:hover {
      background: rgba(179, 229, 252, 1);
    }
    /* √Årea de toque para registrar distracciones */
    .tap-area {
      position: absolute;
      top: 15%;
      left: 0;
      width: 100%;
      height: 75%;
      z-index: 1;
      background: transparent;
      cursor: pointer;
    }
    /* Temporizador y contador */
    .timer-counter {
      position: absolute;
      top: 15px;
      width: 100%;
      text-align: center;
      font-size: 20px;
      z-index: 10;
      color: #333;
      background: rgba(255,255,255,0.5);
      padding: 5px 0;
    }
    /* Opciones y grupos */
    .options {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .option-group {
      margin: 20px 0;
      text-align: center;
    }
    /* Tabla de historial */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 16px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 12px;
      text-align: center;
    }
    th {
      background: #f2f2f2;
    }
    #historyContent {
      overflow-x: auto;
      max-width: 100%;
    }
    #historyContent::-webkit-scrollbar {
      height: 8px;
    }
    #historyContent::-webkit-scrollbar-track {
      background: transparent;
    }
    #historyContent::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.3);
      border-radius: 4px;
    }
    #historyContent table {
      width: 100%;
      max-width: 100%;
      display: block;
    }
    /* Gr√°ficos */
    #historyGraph, #summaryGraph {
      max-width: 100%;
      margin: 20px auto;
    }
    .top-nav {
      text-align: center;
      margin-bottom: 20px;
    }
    .reset-data {
      font-size: 12px;
      color: #800000;
      cursor: pointer;
      text-align: center;
      margin-top: 10px;
    }
    /* Media Queries */
    @media (max-width: 600px) {
      .screen {
        margin: 20px;
        padding: 20px;
      }
      .button, .red-button {
        width: 90%;
        margin: 10px auto;
      }
      .red-button {
        padding: 10px 20px;
      }
      .arrow-button {
        font-size: 20px;
        padding: 8px;
      }
    }
    /* Pantalla 4: Meditaci√≥n a pantalla completa */
    #screen4.full-screen {
      max-width: 100%;
      margin: 0;
      border-radius: 0;
      padding: 0;
      box-shadow: none;
      height: 100vh;
      width: 100vw;
      background: linear-gradient(135deg, #E0F7FA, #B2EBF2);
      position: relative;
    }
    #screen4.full-screen .tap-area {
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      background: transparent;
      cursor: pointer;
    }
    #screen4.full-screen .red-button {
      position: relative;
      z-index: 3;
      margin: 20px;
      margin-top: 70px;
    }
    /* Slider de duraci√≥n */
    input[type=range] {
      -webkit-appearance: none;
      width: 95%;
      margin: 15px 0;
      height: 8px;
      background: #ddd;
      border-radius: 5px;
      outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #3a3a3a;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: background 0.3s ease;
    }
    input[type=range]::-webkit-slider-thumb:hover {
      background: #555;
    }
    input[type=range]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 50%;
      background: #3a3a3a;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    /* Achievements */
    .badge-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .badge-card {
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, border-color 0.3s ease;
    }
    .badge-card.achieved {
      border-color: #3a3a3a;
      background: #e0ffe0;
    }
    .badge-card:hover {
      transform: translateY(-5px);
    }
    .badge-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .badge-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    .badge-desc {
      font-size: 14px;
      color: #555;
    }
    .level-display {
      text-align: center;
      font-size: 18px;
      margin-bottom: 20px;
      font-weight: 600;
    }
    /* Custom Popup Estilo */
    .custom-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .custom-popup.active {
      display: flex;
    }
    .custom-popup-content {
      background: rgba(224, 247, 250, 0.9);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      max-width: 300px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

<!-- Pantalla 1: Bienvenida e Introducci√≥n -->
<div class="screen active" id="screen1">

  <!-- Banner SOLO en la pantalla 1 -->
  <div class="home-banner">
    <div class="progress-section">
      <!-- Contenedor de la barra -->
      <div class="progress-container">
        <div class="progress-fill" id="progressFill"></div>
        <div class="progress-text" id="progressText">minutos meditados: 0/100</div>
      </div>
      <!-- Texto del nivel -->
      <div class="level-info" id="levelInfo">Nivel: Novato</div>
    </div>
    <!-- Toggle de idioma en la esquina -->
    <div class="lang-toggle">
      <span>EN</span>
      <label class="switch">
        <input type="checkbox" id="langToggle" onchange="toggleLanguage(this.checked)">
        <span class="slider"></span>
      </label>
      <span>ES</span>
    </div>
  </div>

  <header>
    <h1 data-i18n="title">Meditation Trainer</h1>
  </header>

  <!-- Card slider con flechitas -->
  <div class="card-slider">
    <button class="arrow-button" onclick="prevCard()">&#10094;</button>
    <div id="cardContent" class="card-content"></div>
    <button class="arrow-button" onclick="nextCard()">&#10095;</button>
  </div>

  <div class="options">
    <button class="button" onclick="goToScreen(2)" data-i18n="newSession">Nueva Sesi√≥n</button>
    <button class="button" onclick="goToScreen(6)" data-i18n="history">Historial</button>
    <button class="button" onclick="goToScreen(7)" data-i18n="achievements">Insignias</button>
  </div>
</div>

<!-- Pantalla 2: Configuraci√≥n de la Sesi√≥n -->
<div class="screen" id="screen2">
  <header>
    <h2 data-i18n="newSessionHeader">Nueva Sesi√≥n de Meditaci√≥n</h2>
  </header>
  <div class="explanation">
    <p data-i18n="sessionSetupMsg">
      Elige la duraci√≥n y el sonido de fondo. Luego toca en cualquier parte durante la meditaci√≥n para contar distracciones.
    </p>
  </div>
  <div class="options">
    <div class="option-group">
      <p><strong data-i18n="selectDuration">Selecciona Duraci√≥n:</strong></p>
      <input type="range" id="durationSlider" min="5" max="60" step="5" value="5" oninput="updateDurationDisplay(this.value)">
      <div id="durationDisplay">5 <span data-i18n="minutes">minutos</span></div>
    </div>
    <div class="option-group">
      <p><strong data-i18n="selectSound">Selecciona Sonido:</strong></p>
      <button class="button" onclick="selectSound('ocean')" data-group="sound" id="soundOcean"><span data-i18n="ocean">Oc√©ano</span></button>
      <button class="button" onclick="selectSound('rain')" data-group="sound" id="soundRain"><span data-i18n="rain">Lluvia</span></button>
      <button class="button" onclick="selectSound('music')" data-group="sound" id="soundMusic"><span data-i18n="music">M√∫sica Relajante</span></button>
      <button class="button" onclick="selectSound('silence')" data-group="sound" id="soundSilence"><span data-i18n="silence">Silencio</span></button>
    </div>
    <button class="button" onclick="startSessionSetup()" data-i18n="continue">Continuar</button>
    <!-- Nuevo bot√≥n para volver al inicio -->
    <button class="button" onclick="goHome()" data-i18n="backHome">Volver al Inicio</button>
  </div>
</div>


<!-- Pantalla 4: Meditaci√≥n a pantalla completa -->
<div class="screen full-screen" id="screen4">
  <div class="timer-counter">
    <span id="timerDisplay">00:00</span> | <span data-i18n="distractions">Distracciones</span>: <span id="tapCount">0</span>
  </div>
  <button class="red-button" onclick="endSessionEarly()" data-i18n="stopSession">Detener Sesi√≥n</button>
  <div class="tap-area" onclick="recordTap()"></div>
</div>

<!-- Pantalla 5: Resumen de la Sesi√≥n y gr√°fico -->
<div class="screen" id="screen5">
  <header>
    <h2 data-i18n="summaryHeader">Resumen de la Sesi√≥n</h2>
  </header>
  <div class="explanation">
    <p data-i18n="summaryMsg">
      Revisa los resultados de tu sesi√≥n. Con la pr√°ctica notar√°s menos distracciones y mayor enfoque.
    </p>
  </div>
  <div class="options" style="text-align:center;">
    <p id="sessionLength"></p>
    <p><span data-i18n="distractions">Distracciones</span>: <span id="sessionTaps"></span></p>
    <p><span data-i18n="avgInterval">Tiempo Promedio Entre Distracciones</span>: <span id="avgInterval"></span> segundos</p>
    <p><strong data-i18n="encouragement">
      ¬°Sigue practicando, pronto ver√°s mejoras!
    </strong></p>
    <canvas id="summaryGraph" width="400" height="200"></canvas>
    <p id="graphExplanation" data-i18n="graphExplanation"></p>
    <button class="button" onclick="goHome()" data-i18n="backHome">Volver al Inicio</button>
    <button class="button" onclick="goToScreen(6)" data-i18n="viewHistory">Ver Historial</button>
    <!-- Nuevo bot√≥n para ir a la p√°gina de insignias -->
    <button class="button" onclick="goToScreen(7)" data-i18n="viewBadges">Ver Insignias</button>
  </div>
</div>

<!-- Pantalla 6: Historial y gr√°fico -->
<div class="screen" id="screen6">
  <header>
    <h2 data-i18n="historyHeader">Historial</h2>
  </header>
  <div class="top-nav">
    <button class="button" onclick="goHome()" data-i18n="backHome">Volver al Inicio</button>
  </div>
  <div class="explanation">
    <p data-i18n="historyMsg">Revisa tus sesiones pasadas y sigue tu progreso.</p>
  </div>
  <div class="options">
    <canvas id="historyGraph" width="400" height="200"></canvas>
    <div id="historyContent"></div>
   <div class="reset-data" onclick="showResetDataPopup()">
  <span data-i18n="resetData">Borrar Datos</span>
    </div>
  </div>
</div>

<!-- Pantalla 7: Insignias -->
<div class="screen" id="screen7">
  <header>
    <h2 data-i18n="achievements">Insignias</h2>
  </header>
  <div class="level-display" id="levelDisplay"></div>
  <div class="explanation">
    <p data-i18n="achievementsDesc">
      Desbloquea insignias conforme avanzas. ¬°Sigue meditando para ganar puntos y subir de nivel!
    </p>
  </div>
  <div class="badge-grid" id="badgesContainer"></div>
  <div class="options" style="text-align:center;">
    <button class="button" onclick="goHome()" data-i18n="backHome">Volver al Inicio</button>
  </div>
</div>

<!-- Custom Popup Modal -->
<div id="customPopup" class="custom-popup">
  <div class="custom-popup-content">
    <p id="popupMessage"></p>
    <div style="margin-top: 20px;">
      <button class="button" id="popupConfirm"></button>
      <button class="red-button" id="popupCancel"></button>
    </div>
  </div>
</div>

<script>
  /*********** Traducciones ***********/
  const translations = {
    en: {
      title: "Meditation Trainer",
      welcomeSlide1: "Welcome to Meditation Trainer. Track your meditation to boost focus.",
      welcomeSlide2: "Meditation reduces stress and improves your well-being.",
      welcomeSlide3: "Studies show meditation can reshape your brain for the better.",
      welcomeSlide4: "Meditate daily ‚Äì 5 minutes a day beats 1 hour a week. Notice changes in days!",
      newSession: "‚ñ∂Ô∏è New Session",
      newSessionHeader: "New Meditation Session",
      history: "üìÖ History",
      achievements: "ü•á Achievements",
      sessionSetupMsg: "Choose a session duration and a background sound. Then tap anywhere during meditation to count distractions.",
      selectDuration: "Select Duration:",
      minutes: "minutes",
      selectSound: "Select Sound:",
      ocean: "Ocean",
      rain: "Rain",
      music: "Relaxing Music",
      silence: "Silence",
      continue: "Continue",
      distractions: "Distractions",
      stopSession: "Stop Session",
      exitWarning: "Are you sure you want to end the session early?",
      summaryHeader: "Session Summary",
      summaryMsg: "Review your session results. With practice, you'll notice fewer distractions and improved focus.",
      avgInterval: "Average Time Between Distractions",
      encouragement: "Keep practicing‚Äîyou‚Äôll soon see improvement!",
      backHome: "Back to Home",
      viewHistory: "üìÖ View History",
      viewBadges: "ü•á View Badges",
      resetData: "Reset Data",
      resetDataConfirm: "Are you sure you want to reset all data?",
      resetDataAlert: "All data has been reset.",
      graphExplanation: "The higher the graph, the better",
      historyHeader: "History",
      historyMsg: "Review your past sessions and track your progress.",
      achievementsDesc: "Unlock badges as you progress. Keep meditating to earn points and level up!",
      confirm: "Yes",
      cancel: "No"
    },
    es: {
      title: "Entrenador de Meditaci√≥n",
     welcomeSlide1: "Bienvenido a Entrenador de Meditaci√≥n. Una herramienta dise√±ada para ayudarte a entrenar tu mente y desarrollar el h√°bito de meditar de forma efectiva.",
welcomeSlide2: "La meditaci√≥n no es ‚Äòponer la mente en blanco‚Äô. Es entrenar tu atenci√≥n. Puedes enfocarte en tu respiraci√≥n, tu cuerpo o lo que te rodea.",
welcomeSlide3: "Tu mente se va a distraer. Es normal. Pero cada vez que notes que se desvi√≥ y la traigas de vuelta, estar√°s progresando. As√≠ es como entrenas.",
welcomeSlide4: "Est√° cient√≠ficamente comprobado: la meditaci√≥n cambia f√≠sicamente tu cerebro. Aumenta la materia gris en √°reas clave como la memoria, la concentraci√≥n y la gesti√≥n del estr√©s.",
welcomeSlide5: "Nuestra app no solo mide el tiempo que meditas, sino c√≥mo evoluciona tu concentraci√≥n. Lleva un registro de tus distracciones y te muestra c√≥mo cada sesi√≥n mejoras.",
welcomeSlide6: "La clave est√° en la constancia: 10 minutos al d√≠a son m√°s efectivos que una hora a la semana. Un poco cada d√≠a transforma tu mente y tu vida.",
welcomeSlide7: "Con el tiempo, ver√°s c√≥mo tu mente se distrae menos y tu enfoque se fortalece. Meditar deja de ser un desaf√≠o y se convierte en un superpoder.",
welcomeSlide8: "Empieza hoy. Entrena tu atenci√≥n, reduce el estr√©s y transforma tu bienestar con solo unos minutos al d√≠a.",
      newSession: "‚ñ∂Ô∏è Nueva Sesi√≥n",
      newSessionHeader: "Nueva Sesi√≥n de Meditaci√≥n",
      history: "üìÖ Historial",
      achievements: "ü•á Insignias",
      sessionSetupMsg: "Elige la duraci√≥n y el sonido de fondo. Luego toca en cualquier parte durante la meditaci√≥n para contar distracciones.",
      selectDuration: "Selecciona Duraci√≥n:",
      minutes: "minutos",
      selectSound: "Selecciona Sonido:",
      ocean: "Oc√©ano",
      rain: "Lluvia",
      music: "M√∫sica Relajante",
      silence: "Silencio",
      continue: "Continuar",
      distractions: "Distracciones",
      stopSession: "Detener Sesi√≥n",
      exitWarning: "¬øEst√°s seguro de que deseas finalizar la sesi√≥n anticipadamente?",
      summaryHeader: "Resumen de la Sesi√≥n",
      summaryMsg: "Revisa los resultados de tu sesi√≥n. Con la pr√°ctica notar√°s menos distracciones y mayor enfoque.",
      avgInterval: "Tiempo Promedio Entre Distracciones",
      encouragement: "¬°Sigue practicando, pronto ver√°s mejoras!",
      backHome: "Volver al Inicio",
      viewHistory: "üìÖ Ver Historial",
      viewBadges: "ü•á Ver Insignias",
      resetData: "Borrar Datos",
      resetDataConfirm: "¬øEst√°s seguro de que deseas borrar todos los datos?",
      resetDataAlert: "Todos los datos han sido borrados.",
      graphExplanation: "Mientras m√°s alto el gr√°fico, mejor",
      historyHeader: "Historial",
      historyMsg: "Revisa tus sesiones pasadas y sigue tu progreso.",
      achievementsDesc: "Desbloquea insignias conforme avanzas. ¬°Sigue meditando para ganar puntos y subir de nivel!",
      confirm: "S√≠",
      cancel: "No"
    }
  };

  // Textos para el card slider
  const meditationQuotes = {
  en: [
  "Welcome to Meditation Trainer!\n\nüí° A powerful tool to train your mind and build the habit of meditation.",
  "Meditation is NOT about blanking your mind!\n\nüëâ It‚Äôs about honing your attention. Focus on your breath, your body, or your surroundings.",
  "Your mind will wander...\n\nüòå And that‚Äôs completely normal!\nEach time you notice it drifting and bring it back,\nyou‚Äôre strengthening your focus.",
  "Track Your Progress:\n\nüìà The goal of our app is to monitor your distractions and show your progress, session by session.",
  "Science Proves It:\n\nüî¨ Meditation transforms your brain by boosting gray matter\nin key areas like memory, focus, and stress management.",
  "Consistency is Key!\n\n‚è±Ô∏è Just 10 minutes a day is more effective than one hour a week.\nSmall daily steps make a huge difference.",
  "Watch Your Focus Grow:\n\nüî• Over time, you‚Äôll notice fewer distractions and a stronger focus.\nMeditation turns into a superpower that transforms your life.",
  "Start Today!\n\nüöÄ Train your attention, reduce stress, and boost your well-being\nwith just a few minutes a day."
],
es: [
  "¬°Bienvenido a Entrenador de Meditaci√≥n!\n\nüí° Una herramienta poderosa para entrenar tu mente y formar el h√°bito de meditar.",
  "¬°La meditaci√≥n NO es poner la mente en blanco!\n\nüëâ Se trata de afinar tu atenci√≥n. Enf√≥cate en tu respiraci√≥n, tu cuerpo o en lo que te rodea.",
  "Tu mente se distraer√°...\n\nüòå ¬°Y eso es totalmente normal!\nCada vez que notes la distracci√≥n y la recobres,\nestar√°s fortaleciendo tu concentraci√≥n.",
  "Lleva un Registro de Tu Progreso:\n\nüìà El objetivo de nuestra app es ese: registrar tus distracciones y mostrarte tu progreso en cada sesi√≥n.",
  "Comprobado Cient√≠ficamente:\n\nüî¨ La meditaci√≥n transforma tu cerebro al aumentar la materia gris\nen √°reas clave como la memoria, el enfoque y la gesti√≥n del estr√©s.",
  "¬°La Constancia es la Clave!\n\n‚è±Ô∏è Solo 10 minutos al d√≠a son m√°s efectivos que una hora a la semana.\nPeque√±os pasos diarios hacen una gran diferencia.",
  "Observa C√≥mo Crece Tu Enfoque:\n\nüî• Con el tiempo, ver√°s menos distracciones y un enfoque m√°s fuerte.\nLa meditaci√≥n se convierte en un superpoder que transforma tu vida.",
  "¬°Empieza Hoy!\n\nüöÄ Entrena tu atenci√≥n, reduce el estr√©s y eleva tu bienestar\ncon solo unos minutos al d√≠a."
]

  };
  
  

  // Definici√≥n de insignias (badges)
  const badgeDefinitions = [
    { id: 1, title_en: "First Meditation", title_es: "Primera Meditaci√≥n", icon: "üå±", description_en: "Complete your first meditation session.", description_es: "Completa tu primera sesi√≥n de meditaci√≥n.", condition: (stats) => stats.totalSessions >= 1 },
    { id: 2, title_en: "3-Day Streak", title_es: "Racha de 3 D√≠as", icon: "üìÖ", description_en: "Meditate for 3 consecutive days.", description_es: "Medita 3 d√≠as consecutivos.", condition: (stats) => stats.maxStreak >= 3 },
    { id: 3, title_en: "7-Day Streak", title_es: "Racha de 7 D√≠as", icon: "7Ô∏è‚É£", description_en: "Meditate for 7 consecutive days.", description_es: "Medita 7 d√≠as consecutivos.", condition: (stats) => stats.maxStreak >= 7 },
    { id: 4, title_en: "15-Day Streak", title_es: "Racha de 15 D√≠as", icon: "1Ô∏è‚É£5Ô∏è‚É£", description_en: "Meditate for 15 consecutive days.", description_es: "Medita 15 d√≠as consecutivos.", condition: (stats) => stats.maxStreak >= 15 },
    { id: 5, title_en: "30-Day Streak", title_es: "Racha de 30 D√≠as", icon: "3Ô∏è‚É£0Ô∏è‚É£", description_en: "Meditate for 30 consecutive days.", description_es: "Medita 30 d√≠as consecutivos.", condition: (stats) => stats.maxStreak >= 30 },
    { id: 6, title_en: "Long Meditation", title_es: "Meditaci√≥n Larga", icon: "‚è±Ô∏è", description_en: "Complete a session lasting 45 minutes or more.", description_es: "Completa una sesi√≥n de 45 minutos o m√°s.", condition: (stats) => stats.longMeditationCount >= 1 },
    { id: 7, title_en: "Focused Mind", title_es: "Mente Enfocada", icon: "üéØ", description_en: "Achieve a session with 1 or fewer distractions.", description_es: "Logra una sesi√≥n con 1 o menos distracciones.", condition: (stats) => stats.focusedSessionCount >= 1 },
    { id: 8, title_en: "Silent Mind", title_es: "Mente Silenciosa", icon: "ü§´", description_en: "Complete a session with zero distractions.", description_es: "Completa una sesi√≥n sin distracciones.", condition: (stats) => stats.silentSessionCount >= 1 },
    { id: 9, title_en: "Five Long Meditations", title_es: "Cinco Meditaciones Largas", icon: "5Ô∏è‚É£", description_en: "Complete 5 sessions of at least 30 minutes.", description_es: "Completa 5 sesiones de al menos 30 minutos.", condition: (stats) => stats.long30Count >= 5 },
    { id: 10, title_en: "Consistency", title_es: "Constancia", icon: "üèÜ", description_en: "Complete 10 meditation sessions.", description_es: "Completa 10 sesiones de meditaci√≥n.", condition: (stats) => stats.totalSessions >= 10 },
    { id: 11, title_en: "Meditation Master", title_es: "Maestro de la Meditaci√≥n", icon: "ü•á", description_en: "Complete 50 meditation sessions.", description_es: "Completa 50 sesiones de meditaci√≥n.", condition: (stats) => stats.totalSessions >= 50 },
    { id: 12, title_en: "Meditation Marathon", title_es: "Marat√≥n de Meditaci√≥n", icon: "‚è≥", description_en: "Accumulate 300 minutes of meditation.", description_es: "Acumula 300 minutos de meditaci√≥n.", condition: (stats) => stats.totalMinutes >= 300 },
    { id: 13, title_en: "Meditation God", title_es: "Dios de la Meditaci√≥n", icon: "üôè", description_en: "Accumulate 600 minutes of meditation.", description_es: "Acumula 600 minutos de meditaci√≥n.", condition: (stats) => stats.totalMinutes >= 600 },
    { id: 14, title_en: "Buddha", title_es: "Buddha", icon: "üßò", description_en: "Accumulate 900 minutes of meditation.", description_es: "Acumula 900 minutos de meditaci√≥n.", condition: (stats) => stats.totalMinutes >= 900 },
    { id: 15, title_en: "Committed", title_es: "Comprometido", icon: "üí™", description_en: "Meditate at least one hour a day for 7 consecutive days.", description_es: "Medita al menos una hora diaria durante 7 d√≠as consecutivos.", condition: (stats) => stats.hourStreak >= 7 }
  ];

  // Declaraci√≥n global para Wake Lock
  let wakeLock = null;

  // Variables para el card slider
  let cardTexts = [];
  let currentCardIndex = 0;
  function updateCardContent() {
    document.getElementById("cardContent").innerText = cardTexts[currentCardIndex];
  }
  function nextCard() {
    currentCardIndex = (currentCardIndex + 1) % cardTexts.length;
    updateCardContent();
  }
  function prevCard() {
    currentCardIndex = (currentCardIndex - 1 + cardTexts.length) % cardTexts.length;
    updateCardContent();
  }

  const browserLang = navigator.language.slice(0,2);
  let lang = translations[browserLang] ? browserLang : "en";

  document.addEventListener("DOMContentLoaded", () => {
    // Inicializa el toggle seg√∫n el idioma
    document.getElementById("langToggle").checked = (lang === "es");
    
    updateDurationDisplay(document.getElementById("durationSlider").value);
    
    // Inicializa los textos del card slider
    cardTexts = meditationQuotes[lang];
    
    updateCardContent();
    goToScreen(1);
  });

  // Actualiza la barra de progreso y el nivel
  function updateHomeLevelDisplay() {
    let points = Math.floor(parseFloat(localStorage.getItem("userPoints")) || 0);
    // Definici√≥n de niveles y umbrales
    const levels = [
      { key: "Rookie", en: "Rookie", es: "Novato", min: 0, max: 100 },
      { key: "Intermediate", en: "Intermediate", es: "Intermedio", min: 100, max: 400 },
      { key: "Meditation God", en: "Meditation God", es: "Dios de la Meditaci√≥n", min: 400, max: 1200 },
      { key: "Buddha", en: "Buddha", es: "Buddha", min: 1200, max: Infinity }
    ];
    let currentLevel = levels.find(l => points < l.max) || levels[levels.length-1];
    const progressFill = document.getElementById("progressFill");
    const progressText = document.getElementById("progressText");
    const levelInfo = document.getElementById("levelInfo");

    // Calcula el porcentaje para la barra
    let percent = Math.min(100, ((points - currentLevel.min) / (currentLevel.max - currentLevel.min)) * 100);
    progressFill.style.width = percent + "%";

    // Texto: "minutos meditados: X/Y"
    progressText.textContent = (lang === "es" ? "minutos meditados: " : "meditated minutes: ")
                              + points + "/" + (currentLevel.max === Infinity ? "‚àû" : currentLevel.max);

    // Nivel: "Nivel: Novato" o "Nivel: Rookie"
    levelInfo.textContent = (lang === "es" ? "Nivel: " : "Level: ")
                            + (lang === "es" ? currentLevel.es : currentLevel.en);
  }

  function updateTranslations() {
    document.querySelectorAll("[data-i18n]").forEach(elem => {
      const key = elem.getAttribute("data-i18n");
      if (translations[lang][key]) {
        elem.textContent = translations[lang][key];
      }
    });
    document.title = translations[lang].title;
    if(document.getElementById("durationSlider")){
      document.getElementById("durationDisplay").innerHTML = document.getElementById("durationSlider").value + " " + translations[lang].minutes;
    }
    cardTexts = meditationQuotes[lang];
    updateCardContent();
  }

  function setLanguage(selectedLang) {
    if (translations[selectedLang]) {
      lang = selectedLang;
      updateTranslations();
      if(document.getElementById('historyContent').innerHTML !== ""){
        loadHistory();
      }
      updateHomeLevelDisplay();
    }
  }
  
  // Funci√≥n para el toggle de idioma: false = en, true = es
  function toggleLanguage(isEs) {
    setLanguage(isEs ? "es" : "en");
  }

  function updateDurationDisplay(val) {
    selectedDuration = parseInt(val);
    document.getElementById("durationDisplay").innerHTML = val + " " + translations[lang].minutes;
  }

  function goToScreen(screenNumber) {
    document.querySelectorAll('.screen').forEach(screen => {
      screen.classList.remove('active');
    });
    if(screenNumber === 1){
      meditationStarted = false;
      updateHomeLevelDisplay();
    }
    const selectedScreen = document.getElementById(`screen${screenNumber}`);
    selectedScreen.classList.add('active');
    if (screenNumber === 6) {
      loadHistory();
    }
    if (screenNumber === 7) {
      updateUserLevelDisplay();
      renderAchievements();
    }
  }

  function goHome() {
    try { if (timerInterval) clearInterval(timerInterval); } catch(e) { console.error(e); }
    try { stopAlarm(); } catch(e) { console.error(e); }
    try { stopBackgroundSound(); } catch(e) { console.error(e); }
    try { releaseWakeLock(); } catch(e) { console.error(e); }
    goToScreen(1);
  }

  function clearSelection(group) {
    document.querySelectorAll(`.option-group button[data-group="${group}"]`).forEach(btn => {
      btn.classList.remove('selected');
    });
  }

  function selectSound(soundType) {
    selectedSound = soundType;
    clearSelection('sound');
    switch(soundType){
      case "ocean":
        document.getElementById("soundOcean").classList.add('selected');
        break;
      case "rain":
        document.getElementById("soundRain").classList.add('selected');
        break;
      case "music":
        document.getElementById("soundMusic").classList.add('selected');
        break;
      case "silence":
        document.getElementById("soundSilence").classList.add('selected');
        break;
    }
  }

  let sessionDuration = 0;
  let timerInterval;
  let timeRemaining = 0;
  let tapCounter = 0;
  let tapTimestamps = [];
  let sessionStartTime;
  let audioAlarm;
  let audioBackground;
  let meditationStarted = false;
  let backgroundSound = "silence";

  let selectedDuration = 5;
  let selectedSound = "silence";

  function startSessionSetup() {
    if (!selectedDuration) {
      alert(translations[lang].selectDuration + " " + translations[lang].minutes);
      return;
    }
    sessionDuration = selectedDuration * 60;
    backgroundSound = selectedSound;
    goToScreen(4);
  }

  async function requestWakeLock() {
    if ('wakeLock' in navigator) {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log("Wake Lock activado");
      } catch (err) {
        console.error(`Error al solicitar Wake Lock: ${err.name}, ${err.message}`);
      }
    }
  }
  function releaseWakeLock() {
    if (wakeLock !== null) {
      wakeLock.release().then(() => {
        wakeLock = null;
        console.log("Wake Lock liberado");
      });
    }
  }

  function preloadAlarm() {
    if (!audioAlarm) {
      audioAlarm = new Audio("https://cdn.glitch.global/8b472fdc-7a0e-4413-a5c0-df3086ec73d8/alarm.mp3?v=1738962246785");
      audioAlarm.preload = "auto";
      audioAlarm.load();
    }
  }

  function startMeditation() {
    if(meditationStarted) return;
    meditationStarted = true;
    
    preloadAlarm();

    tapCounter = 0;
    tapTimestamps = [];
    sessionStartTime = Date.now();
    timeRemaining = sessionDuration;
    updateTimerDisplay();

    if(backgroundSound !== "silence"){
      playBackgroundSound(backgroundSound);
    }
    
    requestWakeLock();
    
    timerInterval = setInterval(() => {
      timeRemaining--;
      updateTimerDisplay();
      if (timeRemaining <= 0) {
        endSession();
      }
    }, 1000);
  }
  function updateTimerDisplay() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    document.getElementById('timerDisplay').textContent = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    document.getElementById('tapCount').textContent = tapCounter;
  }
  function recordTap() {
    if (timeRemaining > 0) {
      tapCounter++;
      tapTimestamps.push(Date.now());
      document.getElementById('tapCount').textContent = tapCounter;
    }
  }
  function endSessionEarly() {
    showCustomPopup();
  }
  function showCustomPopup() {
    const popup = document.getElementById('customPopup');
    const popupMessage = document.getElementById('popupMessage');
    const popupConfirm = document.getElementById('popupConfirm');
    const popupCancel = document.getElementById('popupCancel');
    
    popupMessage.textContent = translations[lang].exitWarning;
    popupConfirm.textContent = translations[lang].confirm;
    popupCancel.textContent = translations[lang].cancel;
    
    popup.classList.add('active');
    
    popupConfirm.onclick = function() {
       popup.classList.remove('active');
       endSession(false);
    };
    popupCancel.onclick = function() {
       popup.classList.remove('active');
    };
  }
  function endSession(playAlarmFlag = true) {
    clearInterval(timerInterval);
    stopBackgroundSound();
    releaseWakeLock();
    
    if (playAlarmFlag) {
      playAlarm();
    }
      
    const actualSessionLength = Math.floor((Date.now() - sessionStartTime) / 1000);
    let avgInterval = 0;
    if (tapTimestamps.length > 1) {
      const intervals = [];
      for (let i = 1; i < tapTimestamps.length; i++) {
        intervals.push((tapTimestamps[i] - tapTimestamps[i - 1]) / 1000);
      }
      avgInterval = (intervals.reduce((a, b) => a + b, 0) / intervals.length).toFixed(0);
    } else if (tapTimestamps.length === 1) {
      avgInterval = actualSessionLength;
    }
    
    const sessionData = {
      date: new Date().toLocaleString(),
      duration: actualSessionLength,
      distractions: tapCounter,
      avgInterval: avgInterval
    };
    
    saveSession(sessionData);
    updateUserPoints(sessionData);
    
    document.getElementById('sessionLength').textContent = (lang === "en" ? "Session Length: " : "Duraci√≥n de la Sesi√≥n: ") + actualSessionLength + (lang === "en" ? " seconds" : " segundos");
    document.getElementById('sessionTaps').textContent = tapCounter;
    document.getElementById('avgInterval').textContent = avgInterval;
    setTimeout(plotSummaryGraph, 100);
    goToScreen(5);
  }

  function playBackgroundSound(soundType) {
    let soundUrl = "";
    switch(soundType){
      case "ocean":
        soundUrl = "https://cdn.glitch.me/8b472fdc-7a0e-4413-a5c0-df3086ec73d8/ocean.mp3?v=1738588174113";
        break;
      case "rain":
        soundUrl = "https://cdn.glitch.me/8b472fdc-7a0e-4413-a5c0-df3086ec73d8/rain.mp3?v=1738588196191";
        break;
      case "music":
        soundUrl = "https://cdn.glitch.me/8b472fdc-7a0e-4413-a5c0-df3086ec73d8/music.mp3?v=1738588191326";
        break;
      default:
        soundUrl = "";
    }
    if(soundUrl){
      audioBackground = new Audio(soundUrl);
      audioBackground.loop = true;
      audioBackground.play();
    }
  }
  function stopBackgroundSound() {
    if(audioBackground) {
      audioBackground.pause();
      audioBackground.currentTime = 0;
    }
  }
  function playAlarm() {
    if (!audioAlarm) {
      preloadAlarm();
    }
    audioAlarm.currentTime = 0;
    audioAlarm.play().catch(e => console.error("Error al reproducir la alarma:", e));
    setTimeout(() => {
      stopAlarm();
    }, 3000);
  }
  function stopAlarm() {
    if (audioAlarm) {
      audioAlarm.pause();
      audioAlarm.currentTime = 0;
    }
  }
  function saveSession(sessionData) {
    const history = JSON.parse(localStorage.getItem("meditationHistory")) || [];
    history.push(sessionData);
    localStorage.setItem("meditationHistory", JSON.stringify(history));
  }
  function loadHistory() {
    const history = JSON.parse(localStorage.getItem("meditationHistory")) || [];
    let content = "";
    if (history.length === 0) {
      content = `<p>${translations[lang].historyMsg}</p>`;
    } else {
      content = "<table><tr><th>" + (lang === "en" ? "Date" : "Fecha") + "</th><th>" + (lang === "en" ? "Duration (sec)" : "Duraci√≥n (seg)") + "</th><th>" + (lang === "en" ? "Distractions" : "Distracciones") + "</th><th>" + (lang === "en" ? "Avg Interval (sec)" : "Intervalo Promedio (seg)") + "</th><th>" + (lang === "en" ? "Actions" : "Acciones") + "</th></tr>";
      history.forEach((session, index) => {
        content += `<tr>
                      <td>${session.date}</td>
                      <td>${session.duration}</td>
                      <td>${session.distractions}</td>
                      <td>${session.avgInterval}</td>
                      <td><button class="red-button" onclick="removeSession(${index})">${lang === "en" ? "Delete" : "Eliminar"}</button></td>
                    </tr>`;
      });
      content += "</table>";
    }
    document.getElementById('historyContent').innerHTML = content;
    plotHistoryGraph(history);
  }
  function showResetDataPopup() {
  const popup = document.getElementById('customPopup');
  const popupMessage = document.getElementById('popupMessage');
  const popupConfirm = document.getElementById('popupConfirm');
  const popupCancel = document.getElementById('popupCancel');

  // Configuramos el mensaje de confirmaci√≥n y los textos de los botones
  popupMessage.textContent = translations[lang].resetDataConfirm; 
  popupConfirm.textContent = translations[lang].confirm;
  popupCancel.textContent = translations[lang].cancel;

  // Mostramos el popup de confirmaci√≥n
  popup.classList.add('active');

  // Al confirmar, se borran los datos y se muestra un mensaje de √©xito en el mismo popup
  popupConfirm.onclick = function() {
    // Borramos los datos
    localStorage.removeItem("meditationHistory");
    localStorage.removeItem("userPoints");
    // Actualizamos la interfaz
    loadHistory();
    updateUserLevelDisplay();
    updateHomeLevelDisplay();

    // Mostramos el mensaje de √©xito
    popupMessage.textContent = translations[lang].resetDataAlert;
    // Ocultamos temporalmente los botones para que se vea solo el mensaje
    popupConfirm.style.display = 'none';
    popupCancel.style.display = 'none';

    // Despu√©s de 1 segundos, cerramos el popup y restauramos los botones
    setTimeout(() => {
      popup.classList.remove('active');
      popupConfirm.style.display = '';
      popupCancel.style.display = '';
    }, 1000);
  };

  // Cancelar cierra el popup sin hacer cambios
  popupCancel.onclick = function() {
    popup.classList.remove('active');
  };
}


  function resetAllData() {
    if (confirm(translations[lang].resetDataConfirm)) {
      localStorage.removeItem("meditationHistory");
      localStorage.removeItem("userPoints");
      alert(translations[lang].resetDataAlert);
      loadHistory();
      updateUserLevelDisplay();
      updateHomeLevelDisplay();
    }
  }

  let historyChart;
  function plotHistoryGraph(history) {
    const labels = history.map((session, index) => `#${index + 1}`);
    const avgIntervals = history.map(session => parseFloat(session.avgInterval));
    const ctx = document.getElementById('historyGraph').getContext('2d');
    if (historyChart) {
      historyChart.destroy();
    }
    historyChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: translations[lang].avgInterval,
          data: avgIntervals,
       backgroundColor: 'rgba(0, 123, 255, 0.2)',  // Azul claro
        borderColor: 'rgba(0, 123, 255, 1)',  // Azul oscuro
        borderWidth: 2,
        fill: true,
        tension: 0.3
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#333' },
            grid: { color: 'rgba(58, 58, 58, 0.1)' }
          },
          x: {
            ticks: { color: '#333' },
            grid: { display: false }
          }
        },
        plugins: {
          legend: {
            labels: { color: '#333' }
          }
        }
      }
    });
  }

  let summaryChart;
  function plotSummaryGraph() {
    const history = JSON.parse(localStorage.getItem("meditationHistory")) || [];
    const labels = history.map((session, index) => `#${index + 1}`);
    const avgIntervals = history.map(session => parseFloat(session.avgInterval));
    const ctx = document.getElementById('summaryGraph').getContext('2d');
    if (summaryChart) {
      summaryChart.destroy();
    }
    summaryChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: translations[lang].avgInterval,
          data: avgIntervals,
          backgroundColor: 'rgba(0, 123, 255, 0.2)',  // Azul claro
        borderColor: 'rgba(0, 123, 255, 1)',  // Azul oscuro
        borderWidth: 2,
        fill: true,
        tension: 0.3
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#333' },
            grid: { color: 'rgba(58, 58, 58, 0.1)' }
          },
          x: {
            ticks: { color: '#333' },
            grid: { display: false }
          }
        },
        plugins: {
          legend: {
            labels: { color: '#333' }
          }
        }
      }
    });
  }

  function removeSession(index) {
    const history = JSON.parse(localStorage.getItem("meditationHistory")) || [];
    history.splice(index, 1);
    localStorage.setItem("meditationHistory", JSON.stringify(history));
    loadHistory();
  }

  function getHourStreak(sessions) {
    const filtered = sessions.filter(s => s.duration >= 3600);
    if(filtered.length === 0) return 0;
    let dates = filtered.map(s => new Date(s.date));
    dates.sort((a, b) => a - b);
    let streak = 1;
    let maxStreak = 1;
    for (let i = 1; i < dates.length; i++) {
      let diffDays = (dates[i] - dates[i - 1]) / (1000 * 3600 * 24);
      if(diffDays >= 0.9 && diffDays <= 1.5) {
        streak++;
      } else {
        streak = 1;
      }
      if(streak > maxStreak) maxStreak = streak;
    }
    return maxStreak;
  }

  function updateUserLevelDisplay() {
    let points = Math.floor(parseFloat(localStorage.getItem("userPoints")) || 0);
    let level = getUserLevel(points);
    let label = lang === "en" ? "Current Level:" : "Nivel Actual:";
    let totalLabel = lang === "en" ? "Meditated minutes:" : "Minutos meditados:";
    document.getElementById("levelDisplay").innerHTML = label + " " + level + " (" + totalLabel + " " + points + ")";
  }

  function getMaxStreak(sessions) {
    if(sessions.length === 0) return 0;
    let dates = sessions.map(s => new Date(s.date));
    dates.sort((a,b) => a - b);
    let streak = 1;
    let maxStreak = 1;
    for (let i = 1; i < dates.length; i++) {
      let diffDays = (dates[i] - dates[i - 1]) / (1000 * 3600 * 24);
      if(diffDays >= 0.9 && diffDays <= 1.5) {
        streak++;
      } else if(diffDays > 1.5) {
        streak = 1;
      }
      if(streak > maxStreak) maxStreak = streak;
    }
    return maxStreak;
  }

  function updateUserPoints(sessionData) {
    let points = parseFloat(localStorage.getItem("userPoints")) || 0;
    let sessionPoints = sessionData.duration / 60;
    if (sessionData.distractions == 0 && sessionData.duration >= 60) {
      sessionPoints += 10;
    }
    points += sessionPoints;
    localStorage.setItem("userPoints", points);
    return points;
  }

  function getUserLevel(points) {
    if(points < 100) return "Rookie";
    else if(points < 400) return "Intermediate";
    else if(points < 1200) return "Meditation God";
    else return "Buddha";
  }

  function renderAchievements() {
    let history = JSON.parse(localStorage.getItem("meditationHistory")) || [];
    let totalSessions = history.length;
    let totalMinutes = history.reduce((sum, session) => sum + session.duration / 60, 0);
    let maxStreak = getMaxStreak(history);
    let longMeditationCount = history.filter(s => s.duration >= 45 * 60).length;
    let focusedSessionCount = history.filter(s => s.distractions <= 1).length;
    let silentSessionCount = history.filter(s => s.distractions == 0).length;
    let long30Count = history.filter(s => s.duration >= 30 * 60).length;
    let hourStreak = getHourStreak(history);
    
    let stats = { totalSessions, totalMinutes, maxStreak, longMeditationCount, focusedSessionCount, silentSessionCount, long30Count, hourStreak };

    let badgesHTML = "";
    badgeDefinitions.forEach(badge => {
      let achieved = badge.condition(stats);
      let title = (lang === "es") ? badge.title_es : badge.title_en;
      let desc = (lang === "es") ? badge.description_es : badge.description_en;
      badgesHTML += `<div class="badge-card ${achieved ? "achieved" : ""}">
        <div class="badge-icon">${badge.icon}</div>
        <div class="badge-title">${title}</div>
        <div class="badge-desc">${desc}</div>
      </div>`;
    });
    document.getElementById("badgesContainer").innerHTML = badgesHTML;
  }

  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.target.id === "screen4" && mutation.target.classList.contains("active")) {
        setTimeout(startMeditation, 500);
      }
    });
  });
  document.querySelectorAll('.screen').forEach(screen => {
    observer.observe(screen, { attributes: true });
  });

  window.onload = () => {
    updateTranslations();
    goToScreen(1);
  };
</script>
</body>
</html>
